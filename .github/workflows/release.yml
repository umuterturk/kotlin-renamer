name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Run tests
        run: go test ./...

  release:
    name: Release
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Build binaries
        run: |
          VERSION=${GITHUB_REF_NAME}
          mkdir -p dist

          platforms=(
            "darwin/amd64"
            "darwin/arm64"
            "linux/amd64"
            "linux/arm64"
            "windows/amd64"
          )

          for platform in "${platforms[@]}"; do
            OS="${platform%/*}"
            ARCH="${platform#*/}"

            OUTPUT="kr"
            [ "$OS" = "windows" ] && OUTPUT="kr.exe"

            GOOS=$OS GOARCH=$ARCH go build -ldflags="-s -w -X main.version=${VERSION}" -o "dist/${OUTPUT}" .

            ARCHIVE="dist/kr_${OS}_${ARCH}"
            if [ "$OS" = "windows" ]; then
              zip "${ARCHIVE}.zip" -j "dist/${OUTPUT}"
              rm "dist/${OUTPUT}"
            else
              tar -czf "${ARCHIVE}.tar.gz" -C dist "${OUTPUT}"
              rm "dist/${OUTPUT}"
            fi
          done

          # Generate checksums
          cd dist && sha256sum * > checksums.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ github.ref_name }}
          body: |
            ## Install

            **macOS (Apple Silicon)**
            ```bash
            curl -L https://github.com/umuterturk/kotlin-renamer/releases/download/${{ github.ref_name }}/kr_darwin_arm64.tar.gz | tar xz
            sudo mv kr /usr/local/bin/
            ```

            **macOS (Intel)**
            ```bash
            curl -L https://github.com/umuterturk/kotlin-renamer/releases/download/${{ github.ref_name }}/kr_darwin_amd64.tar.gz | tar xz
            sudo mv kr /usr/local/bin/
            ```

            **Linux (amd64)**
            ```bash
            curl -L https://github.com/umuterturk/kotlin-renamer/releases/download/${{ github.ref_name }}/kr_linux_amd64.tar.gz | tar xz
            sudo mv kr /usr/local/bin/
            ```

            See [README](https://github.com/umuterturk/kotlin-renamer#readme) for full usage.
          files: dist/*
          draft: false
          prerelease: false
